<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Navegador GPS Real</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.1.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.1.0/dist/ol.js"></script>
    
    <style>
        /* (El CSS es exactamente el mismo, no es necesario cambiarlo) */
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            overflow: hidden; font-family: Arial, sans-serif; background-color: #333;
        }
        #map { height: 100%; width: 100%; background: #f2f2f2; }
        #position-marker {
            position: fixed; left: 50%; bottom: 20%; width: 0; height: 0;
            border-left: 12px solid transparent; border-right: 12px solid transparent;
            border-top: 22px solid #007bff; filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.5));
            transform: translateX(-50%); pointer-events: none; z-index: 1000;
        }
        #status {
            position: fixed; top: 10px; left: 10px; right: 10px;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 8px 12px; border-radius: 5px; text-align: center;
            z-index: 1001; font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="position-marker"></div>
    <div id="status">Inicializando mapa...</div>

    <script>
        // --- CONFIGURACIÓN ---
        const startCoords = [-3.703790, 40.416775]; // Madrid - Sol
        const endCoords = [-3.693352, 40.419208];   // Madrid - Cibeles
        const statusDiv = document.getElementById('status');

        // --- INICIALIZACIÓN INMEDIATA DEL MAPA ---
        // Se crea el mapa tan pronto como se lee el script.
        const view = new ol.View({
            center: ol.proj.fromLonLat(startCoords),
            zoom: 18, minZoom: 15, maxZoom: 20
        });

        const map = new ol.Map({
            target: 'map',
            layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
            view: view,
            controls: [],
            interactions: ol.interaction.defaults({
                dragPan: false, pinchZoom: false, mouseWheelZoom: false, doubleClickZoom: false
            })
        });

        // --- FUNCIONES (sin cambios) ---
        async function drawRoute() {
            statusDiv.textContent = "Obteniendo ruta...";
            const url = `https://router.project-osrm.org/route/v1/driving/${startCoords[0]},${startCoords[1]};${endCoords[0]},${endCoords[1]}?geometries=geojson`;
            try {
                const response = await fetch(url);
                const json = await response.json();
                if (json.code !== 'Ok' || !json.routes || json.routes.length === 0) {
                    throw new Error("No se pudo obtener la ruta.");
                }
                const route = new ol.format.GeoJSON().readFeature(json.routes[0].geometry, {
                    dataProjection: 'EPSG:4326', featureProjection: 'EPSG:3857'
                });
                const routeLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({ features: [route] }),
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({ width: 8, color: 'rgba(255, 0, 0, 0.8)' })
                    })
                });
                map.addLayer(routeLayer);
                statusDiv.textContent = "Ruta cargada. Esperando señal GPS...";
            } catch (error) {
                console.error("Error al obtener la ruta:", error);
                statusDiv.textContent = "Error al calcular la ruta. Comprueba la conexión.";
            }
        }

        function startGpsNavigation() {
            if (!navigator.geolocation) {
                statusDiv.textContent = "Geolocalización no es compatible.";
                return;
            }
            navigator.geolocation.watchPosition(
                (position) => {
                    statusDiv.textContent = "¡Navegando!";
                    const coords = [position.coords.longitude, position.coords.latitude];
                    view.setCenter(ol.proj.fromLonLat(coords));
                    const heading = position.coords.heading;
                    if (heading !== null && heading !== undefined) {
                        view.setRotation((heading * Math.PI) / 180);
                    }
                },
                (error) => {
                    let errorMessage = "Error de GPS: ";
                    switch(error.code) {
                        case error.PERMISSION_DENIED: errorMessage += "Permiso denegado."; break;
                        case error.POSITION_UNAVAILABLE: errorMessage += "Ubicación no disponible."; break;
                        case error.TIMEOUT: errorMessage += "Tiempo de espera agotado."; break;
                        default: errorMessage += "Error desconocido."; break;
                    }
                    statusDiv.textContent = errorMessage;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // --- EJECUCIÓN CUANDO LA PÁGINA ESTÉ LISTA ---
        window.onload = async () => {
            // Se espera a que se cargue la página para ejecutar la lógica de red.
            await drawRoute();
            startGpsNavigation();
        };

    </script>
</body>
</html>
